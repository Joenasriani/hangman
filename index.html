<!DOCTYPE html>
<html>
  <head>
    <title>3D Hangman World</title>
    <meta name="description" content="3D WebXR Hangman game in a living world.">
    <!-- Import A-Frame Library -->
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <!-- Import A-Frame Environment Component -->
    <script src="https://unpkg.com/aframe-environment-component@1.3.4/dist/aframe-environment-component.min.js"></script>
  </head>
  <body>
    <!-- 
      FIX 2: camera-gestures is on the scene to control the playerRig
    -->
    <a-scene game-manager camera-gestures>
      
      <!-- 1. ASSETS & ENVIRONMENT -->
      <a-assets>
        <!-- Sound effects for game events -->
        <audio id="click-sound" src="https://cdn.glitch.global/0b8e9f4a-1e07-4e9e-a8af-101851b6c0ba/click.ogg?v=1730030001889" preload="auto"></audio>
        <audio id="win-sound" src="https://cdn.glitch.global/0b8e9f4a-1e07-4e9e-a8af-101851b6c0ba/win.mp3?v=1730030006797" preload="auto"></audio>
        <audio id="lose-sound" src="https://cdn.glitch.global/0b8e9f4a-1e07-4e9e-a8af-101851b6c0ba/lose.mp3?v=1730030004380" preload="auto"></audio>
      </a-assets>

      <!-- Colorful Environment -->
      <a-entity 
        environment="preset: default; 
                     skyColor: #37b3f0; 
                     ground: flat; 
                     groundColor: #3d592a;
                     groundTexture: none;
                     fog: 0.1;"
      ></a-entity>
      
      <!-- 
        FIX 3: A LIVING WORLD
      -->
      
      <!-- Trees (More of them) -->
      <a-cone color="#1A5913" radius-bottom="0.5" radius-top="0" height="3" position="-5 1.5 -8"></a-cone>
      <a-cylinder color="#5D4037" radius="0.1" height="1.5" position="-5 0.75 -8"></a-cylinder>
      
      <a-cone color="#237018" radius-bottom="0.7" radius-top="0" height="4" position="6 2 -10"></a-cone>
      <a-cylinder color="#5D4037" radius="0.15" height="2" position="6 1 -10"></a-cylinder>
      
      <a-cone color="#1E824C" radius-bottom="0.6" radius-top="0" height="3.5" position="8 1.75 -7"></a-cone>
      <a-cylinder color="#5D4037" radius="0.12" height="1.75" position="8 0.875 -7"></a-cylinder>

      <a-cone color="#1A5913" radius-bottom="0.4" radius-top="0" height="2.5" position="-7 1.25 -12"></a-cone>
      <a-cylinder color="#5D4037" radius="0.1" height="1.25" position="-7 0.625 -12"></a-cylinder>

      <a-cone color="#237018" radius-bottom="0.8" radius-top="0" height="4.5" position="10 2.25 -15"></a-cone>
      <a-cylinder color="#5D4037" radius="0.15" height="2.25" position="10 1.125 -15"></a-cylinder>
      
      <!-- Rocks -->
      <a-dodecahedron color="#888" radius="0.5" position="-4 0.25 -6"></a-dodecahedron>
      <a-dodecahedron color="#777" radius="0.7" position="5 0.35 -7"></a-dodecahedron>
      <a-dodecahedron color="#828282" radius="0.4" position="4.5 0.2 -6.5"></a-dodecahedron>
      <a-dodecahedron color="#7A7A7A" radius="0.6" position="-6 0.3 -9"></a-dodecahedron>

      <!-- Flowers -->
      <a-sphere color="#FFEB3B" radius="0.05" position="3 0.05 -5"></a-sphere>
      <a-sphere color="#FFEB3B" radius="0.05" position="3.1 0.05 -5.1"></a-sphere>
      <a-sphere color="#FFEB3B" radius="0.05" position="2.9 0.05 -4.9"></a-sphere>
      <a-sphere color="#E91E63" radius="0.05" position="-2 0.05 -6"></a-sphere>
      <a-sphere color="#E91E63" radius="0.05" position="-2.1 0.05 -6.1"></a-sphere>
      <a-sphere color="#E91E63" radius="0.05" position="-1.9 0.05 -5.9"></a-sphere>
      
      <!-- Grazing Animal (far away) -->
      <a-entity position="15 0 -12">
        <a-box color="#8B4513" width="1" height="0.6" depth="0.4" position="0 0.8 0"></a-box> <!-- body -->
        <a-box color="#A0522D" width="0.15" height="0.5" depth="0.15" position="-0.4 0.25 0"></a-box> <!-- leg1 -->
        <a-box color="#A0522D" width="0.15" height="0.5" depth="0.15" position="0.4 0.25 0"></a-box> <!-- leg2 -->
        <a-box color="#A0522D" width="0.15" height="0.5" depth="0.15" position="-0.4 0.25 -0.2"></a-box> <!-- leg3 -->
        <a-box color="#A0522D" width="0.15" height="0.5" depth="0.15" position="0.4 0.25 -0.2"></a-box> <!-- leg4 -->
        <a-entity position="0 1.2 0.3"> <!-- head + neck -->
          <a-box color="#A0522D" width="0.2" height="0.5" depth="0.2" position="0 0 0"></a-box> <!-- neck -->
          <a-box color="#8B4513" width="0.25" height="0.25" depth="0.3" position="0 0.3 0.1"></a-box> <!-- head -->
          <!-- Animation for grazing -->
          <a-animation attribute="rotation" from="-20 0 0" to="30 0 0" dur="3000" direction="alternate" repeat="indefinite" easing="ease-in-out"></a-animation>
        </a-entity>
      </a-entity>
      
      <!-- Flying Birds -->
      <a-entity position="0 15 0">
        <a-sphere color="#333" radius="0.1" position="0 0 0"></a-sphere>
        <a-sphere color="#333" radius="0.1" position="-0.2 0.1 -0.1"></a-sphere>
        <a-sphere color="#333" radius="0.1" position="0.2 -0.1 -0.2"></a-sphere>
        <!-- Animation to fly across the sky -->
        <a-animation attribute="position" from="-30 15 -30" to="30 15 -30" dur="20000" repeat="indefinite"></a-animation>
      </a-entity>
      
      <!-- End of Living World -->
      
      <a-light type="ambient" color="#AAA"></a-light>
      <a-light type="point" intensity="0.5" position="2 4 4"></a-light>

      <!-- 2. PLAYER RIG -->
      <!-- Player starts at y=0, camera is at 1.6m high -->
      <a-entity id="playerRig" position="0 0 2">
        <a-camera position="0 1.6 0">
          <!-- Cursor for mobile gaze-based clicking -->
          <a-cursor 
            color="#FFF"
            raycaster="objects: .clickable"
          ></a-cursor>
        </a-camera>
        <!-- Controller with a laser pointer for VR -->
        <a-entity 
          laser-controls="hand: right"
          raycaster="objects: .clickable"
        ></a-entity>
      </a-entity>

      <!-- 3. GAME UI (Fixed in the world) -->
      
      <!-- Word Display -->
      <a-entity 
        id="word-display" 
        position="0 2.5 -3"
        visible="false"
      ></a-entity>
      
      <!-- Status Message -->
      <a-text
        id="status-message"
        value="Welcome to 3D Hangman!"
        align="center"
        width="6"
        position="0 3.1 -3"
        color="#FFF"
      ></a-text>
      
      <!-- 3D Start/Reset Button -->
      <a-entity 
        id="start-reset-button-container" 
        position="0 1.8 -2.5"
      >
        <a-box
          id="start-reset-button"
          class="clickable"
          width="1.5"
          height="0.4"
          depth="0.1"
          color="#00796b"
          animation__hoveron="property: components.material.material.color; type: color; to: #D32F2F; startEvents: mouseenter; dur: 150"
          animation__hoveroff="property: components.material.material.color; type: color; to: #00796b; startEvents: mouseleave; dur: 150"
          animation__clickscale="property: scale; to: 1.2 1.2 1.2; startEvents: mousedown; dur: 100; dir: alternate; loop: 2"
        >
          <a-text
            id="start-reset-button-text"
            value="START HANGMAN"
            align="center"
            width="3"
            position="0 0 0.06"
            color="#FFF"
          ></a-text>
        </a-box>
      </a-entity>
      
      <!-- Keyboard -->
      <a-entity 
        id="keyboard" 
        position="0 1.4 -2.5"
        visible="false"
      ></a-entity>
      
      <!-- 3D Hangman Structure -->
      <a-entity id="hangman-structure" position="0 3.8 -3" scale="0.8 0.8 0.8">
        <a-box id="hm-base" position="0 0.1 0" width="2" height="0.2" depth="1" color="#634737" visible="false"></a-box>
        <a-cylinder id="hm-post" position="0.8 1.1 0" radius="0.1" height="2" color="#634737" visible="false"></a-cylinder>
        <a-box id="hm-beam" position="0.1 2.1 0" width="1.6" height="0.2" depth="0.2" color="#634737" visible="false"></a-box>
        <a-cylinder id="hm-rope" position="-0.6 1.8 0" radius="0.03" height="0.6" color="#D2B48C" visible="false"></a-cylinder>
        <a-sphere id="hm-head" position="-0.6 1.4 0" radius="0.15" color="#FFE4C4" visible="false"></a-sphere>
        <a-box id="hm-body" position="-0.6 1.0 0" width="0.1" height="0.6" depth="0.1" color="#C0392B" visible="false"></a-box>
      </a-entity>

      <!-- Sound entities for 3D audio -->
      <a-sound src="#click-sound" id="keyboardClickSound" position="0 1.4 -2.5"></a-sound>
      <a-sound src="#win-sound" id="winGameSound" position="0 2.5 -3"></a-sound>
      <a-sound src="#lose-sound" id="loseGameSound" position="0 3.8 -3"></a-sound>

    </a-scene>

    <script>
    /*
     * FIX 2: Updated camera-gestures component
     * One finger: Pan (move on X/Z plane)
     * Two fingers: Crane (move on Y axis)
     * Quick tap: Click
     */
    AFRAME.registerComponent('camera-gestures', {
      init: function () {
        this.cameraRig = document.getElementById('playerRig');
        this.sceneEl = this.el;
        
        this.isDragging = false;
        this.isPinching = false;
        
        this.lastDragX = 0;
        this.lastDragY = 0;
        this.lastPinchY = 0;
        
        this.touchStartTime = 0;
        
        this.moveSpeed = 0.01;
        this.craneSpeed = 0.01;

        this.sceneEl.addEventListener('touchstart', this.onTouchStart.bind(this));
        this.sceneEl.addEventListener('touchmove', this.onTouchMove.bind(this));
        this.sceneEl.addEventListener('touchend', this.onTouchEnd.bind(this));
      },

      onTouchStart: function (evt) {
        this.touchStartTime = Date.now();
        this.isDragging = false;
        this.isPinching = false;
        
        if (evt.touches.length === 1) {
          this.lastDragX = evt.touches[0].clientX;
          this.lastDragY = evt.touches[0].clientY;
        } else if (evt.touches.length === 2) {
          this.lastPinchY = (evt.touches[0].clientY + evt.touches[1].clientY) / 2;
        }
      },

      onTouchMove: function (evt) {
        // Mark as dragging if finger moves, to prevent a tap
        this.isDragging = true; 

        if (evt.touches.length === 1) {
          // One-finger drag (Pan X/Z)
          const currentX = evt.touches[0].clientX;
          const currentY = evt.touches[0].clientY;
          const dx = currentX - this.lastDragX;
          const dy = currentY - this.lastDragY;
          
          this.lastDragX = currentX;
          this.lastDragY = currentY;

          // Drag left/right moves X, drag up/down moves Z
          this.cameraRig.object3D.position.x -= dx * this.moveSpeed;
          this.cameraRig.object3D.position.z -= dy * this.moveSpeed;

        } else if (evt.touches.length === 2) {
          // Two-finger drag (Crane Y)
          this.isPinching = true; // Mark as pinching so tap-click doesn't fire
          const currentY = (evt.touches[0].clientY + evt.touches[1].clientY) / 2;
          const dy = currentY - this.lastPinchY;
          this.lastPinchY = currentY;
          
          // Drag up/down moves Y
          this.cameraRig.object3D.position.y += dy * this.craneSpeed;
        }
      },

      onTouchEnd: function (evt) {
        const duration = Date.now() - this.touchStartTime;
        
        // If it was a short touch and not a drag/pinch, it's a tap
        if (this.isDragging === false && this.isPinching === false && duration < 200) {
          this.handleTap();
        }

        this.isDragging = false;
        this.isPinching = false;
      },
      
      handleTap: function () {
        const cursorEl = document.querySelector('a-cursor');
        if (!cursorEl) return;

        const intersectedEl = cursorEl.components.raycaster.intersectedEls[0];
        if (intersectedEl && intersectedEl.classList.contains('clickable')) {
          intersectedEl.dispatchEvent(new CustomEvent('mousedown'));
          intersectedEl.click();
        }
      }
    });

    /*
     * Main Game Logic Component
     */
    AFRAME.registerComponent('game-manager', {
      schema: {},

      init: function () {
        // --- Game State ---
        this.wordList = [
          'WEBXR', 'AFRAME', 'HANGMAN', 'VIRTUAL', 'REALITY', 'JAVASCRIPT', 
          'METAVERSE', 'QUEST', 'CONTROLLER', 'HEADSET', 'IMMERSIVE', 'AUGMENTED', 
          'INTERNET', 'BROWSER', 'DEVELOPER', 'COMPONENT', 'ENTITY', 'SYSTEM', 
          'GITHUB', 'GLITCH', 'CODING', 'PROGRAM', 'CHROME', 'FIREFOX', 
          'MOBILE', 'DESKTOP', 'AVATAR', 'ENVIRONMENT', 'ANIMATION', 'TEXTURE', 
          'POLYGON', 'SHADER'
        ];
        
        this.secretWord = '';
        this.guessedLetters = [];
        this.incorrectGuesses = 0;
        this.maxGuesses = 6; 
        this.gameActive = false;

        // --- A-Frame Entity References ---
        this.wordDisplayEl = document.getElementById('word-display');
        this.keyboardEl = document.getElementById('keyboard');
        this.statusMessageEl = document.getElementById('status-message');
        
        this.resetButtonContainerEl = document.getElementById('start-reset-button-container');
        this.resetButtonEl = document.getElementById('start-reset-button');
        this.resetButtonTextEl = document.getElementById('start-reset-button-text');
        
        // Sound components
        this.keyboardClickSound = document.getElementById('keyboardClickSound');
        this.winGameSound = document.getElementById('winGameSound');
        this.loseGameSound = document.getElementById('loseGameSound');

        this.hangmanParts = [
          document.getElementById('hm-base'),
          document.getElementById('hm-post'),
          document.getElementById('hm-beam'),
          document.getElementById('hm-rope'),
          document.getElementById('hm-head'),
          document.getElementById('hm-body')
        ];

        // --- Initial Setup ---
        this.createKeyboard();
        this.hideHangman();
        
        this.statusMessageEl.setAttribute('value', 'Welcome to 3D Hangman!');
        this.keyboardEl.setAttribute('visible', 'false');
        this.wordDisplayEl.setAttribute('visible', 'false');
        this.resetButtonContainerEl.setAttribute('visible', 'true');
        this.resetButtonTextEl.setAttribute('value', 'START HANGMAN');
        
        // --- Event Listeners ---
        this.keyboardEl.addEventListener('click', this.handleKeyboardClick.bind(this));
        this.resetButtonEl.addEventListener('click', this.startGame.bind(this));
      },

      startGame: function () {
        this.gameActive = true;
        this.guessedLetters = [];
        this.incorrectGuesses = 0;
        this.secretWord = this.wordList[Math.floor(Math.random() * this.wordList.length)];
        
        this.statusMessageEl.setAttribute('value', 'Guess a letter!');
        this.resetButtonContainerEl.setAttribute('visible', 'false'); 
        this.keyboardEl.setAttribute('visible', 'true'); 
        this.wordDisplayEl.setAttribute('visible', 'true'); 
        
        this.resetKeyboard();
        this.hideHangman();
        this.createWordDisplay();
      },
      
      createWordDisplay: function () {
        while (this.wordDisplayEl.firstChild) {
          this.wordDisplayEl.removeChild(this.wordDisplayEl.firstChild);
        }

        const wordLength = this.secretWord.length;
        const letterSpacing = 0.4; 
        const totalWidth = wordLength * letterSpacing; 
        const startX = -totalWidth / 2 + (letterSpacing / 2);

        for (let i = 0; i < wordLength; i++) {
          let letterEl = document.createElement('a-text');
          letterEl.setAttribute('value', '_');
          letterEl.setAttribute('align', 'center');
          letterEl.setAttribute('width', '4');
          letterEl.setAttribute('color', '#FFF');
          letterEl.setAttribute('position', { x: startX + i * letterSpacing, y: 0, z: 0 });
          this.wordDisplayEl.appendChild(letterEl);
        }
      },

      createKeyboard: function () {
        const rows = [
          'QWERTYUIOP',
          'ASDFGHJKL',
          'ZXCVBNM'
        ];
        
        let yPos = 0.5;

        rows.forEach((row, rowIndex) => {
          let rowLength = row.length;
          let keySpac = 0.4;
          let keySize = 0.35;
          let xOffset = -(rowLength * keySpac) / 2 + (keySpac / 2);
          
          for (let i = 0; i < row.length; i++) {
            let letter = row[i];
            
            let button = document.createElement('a-box');
            button.setAttribute('position', { x: xOffset + i * keySpac, y: yPos, z: 0 });
            button.setAttribute('width', keySize);
            button.setAttribute('height', keySize);
            
            // FIX 1: Thicker keys
            button.setAttribute('depth', '0.2'); 
            
            button.setAttribute('color', '#1e88e5'); 
            button.setAttribute('class', 'clickable keyboard-button'); 
            button.setAttribute('data-letter', letter); 
            
            // Hover: Turn Red
            button.setAttribute('animation__hoveron', 'property: components.material.material.color; type: color; to: #D32F2F; startEvents: mouseenter; dur: 150');
            button.setAttribute('animation__hoveroff', 'property: components.material.material.color; type: color; to: #1e88e5; startEvents: mouseleave; dur: 150');
            // Click: Pop
            button.setAttribute('animation__clickscale', 'property: scale; to: 1.3 1.3 1.3; startEvents: mousedown; dur: 100; dir: alternate; loop: 2');
            
            let text = document.createElement('a-text');
            text.setAttribute('value', letter);
            text.setAttribute('align', 'center');
            text.setAttribute('width', '2');
            text.setAttribute('color', '#FFF');
            text.setAttribute('position', '0 0 0.11'); // Adjusted text forward for thicker key
            
            button.appendChild(text);
            this.keyboardEl.appendChild(button);
          }
          yPos -= keySpac; 
        });
      },

      handleKeyboardClick: function (evt) {
        if (!this.gameActive) return;

        const buttonEl = evt.target;
        if (!buttonEl.classList.contains('keyboard-button')) return;
        
        const letter = buttonEl.getAttribute('data-letter');
        if (this.guessedLetters.includes(letter)) return;
        
        this.guessedLetters.push(letter);
        this.keyboardClickSound.components.sound.playSound();

        // Disable button
        buttonEl.setAttribute('color', '#646464'); 
        
        // Force scale to 1 and remove animations
        buttonEl.setAttribute('scale', '1 1 1');
        buttonEl.removeAttribute('animation__hoveron');
        buttonEl.removeAttribute('animation__hoveroff');
        buttonEl.removeAttribute('animation__clickscale');
        
        // Also remove the hoveroff animation that might be queued
        buttonEl.removeAttribute('animation__hoveroff_'); 
        
        this.processGuess(letter);
      },
      
      processGuess: function(letter) {
        let correctGuess = false;
        let wordComplete = true;

        const letterEls = this.wordDisplayEl.children;
        for (let i = 0; i < this.secretWord.length; i++) {
          if (this.secretWord[i] === letter) {
            letterEls[i].setAttribute('value', letter);
            correctGuess = true;
          }
          if (letterEls[i].getAttribute('value') === '_') {
            wordComplete = false;
          }
        }
        
        if (correctGuess) {
          this.statusMessageEl.setAttribute('value', 'Good Guess!');
          if (wordComplete) {
            this.endGame(true);
          }
        } else {
          this.incorrectGuesses++;
          this.statusMessageEl.setAttribute('value', `Incorrect! ${this.maxGuesses - this.incorrectGuesses} guesses left.`);
          this.updateHangman();
          
          if (this.incorrectGuesses >= this.maxGuesses) {
            this.endGame(false);
          }
        }
      },
      
      updateHangman: function() {
        if (this.incorrectGuesses > 0 && this.incorrectGuesses <= this.hangmanParts.length) {
          this.hangmanParts[this.incorrectGuesses - 1].setAttribute('visible', 'true');
        }
      },
      
      endGame: function(didWin) {
        this.gameActive = false;
        
        if (didWin) {
          this.statusMessageEl.setAttribute('value', 'YOU WIN!');
          this.winGameSound.components.sound.playSound();
        } else {
          this.statusMessageEl.setAttribute('value', `YOU LOSE! Word was: ${this.secretWord}`);
          this.loseGameSound.components.sound.playSound();
          const letterEls = this.wordDisplayEl.children;
          for (let i = 0; i < this.secretWord.length; i++) {
             letterEls[i].setAttribute('value', this.secretWord[i]);
          }
        }
        
        this.keyboardEl.setAttribute('visible', 'false');
        this.resetButtonContainerEl.setAttribute('visible', 'true');
        this.resetButtonTextEl.setAttribute('value', 'Play Again?');
      },
      
      resetKeyboard: function() {
        let buttons = this.keyboardEl.querySelectorAll('.keyboard-button');
        buttons.forEach(button => {
          button.setAttribute('color', '#1e88e5'); 
          // Re-add all animations
          button.setAttribute('animation__hoveron', 'property: components.material.material.color; type: color; to: #D32F2F; startEvents: mouseenter; dur: 150');
          button.setAttribute('animation__hoveroff', 'property: components.material.material.color; type: color; to: #1e88e5; startEvents: mouseleave; dur: 150');
          button.setAttribute('animation__clickscale', 'property: scale; to: 1.3 1.3 1.3; startEvents: mousedown; dur: 100; dir: alternate; loop: 2');
        });
      },
      
      hideHangman: function() {
        this.hangmanParts.forEach(part => {
          part.setAttribute('visible', 'false');
        });
      }
    });
    </script>
  </body>
</html>


